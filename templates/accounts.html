{% extends "base.html" %}

{% block title %}Contas{% endblock %}

{% block content %}
<section id="contas" class="tab-content active">
  <div class="page-header">
    <h1>Contas e Obrigações</h1>
    <p>Controle todas as contas e obrigações fiscais</p>
  </div>
  <!-- Resumo e Estatísticas -->
  <div class="content-card">
    <div class="card-header"><h3><i class="fas fa-chart-bar"></i> Resumo das Contas</h3></div>
    <div class="dashboard-grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
      <div class="metric-card">
        <div class="metric-icon contas"><i class="fas fa-calculator"></i></div>
        <div class="metric-content">
          <h3>Total de Contas</h3>
          <div class="metric-value">{{ (contas|length if contas else 0) + (contas_privadas|length if contas_privadas else 0) }}</div>
          <div class="metric-change neutral"><i class="fas fa-list"></i> Todas as categorias</div>
        </div>
      </div>
      <div class="metric-card">
        <div class="metric-icon empresas"><i class="fas fa-globe"></i></div>
        <div class="metric-content">
          <h3>Contas Públicas</h3>
          <div class="metric-value">{{ contas|length if contas else 0 }}</div>
          <div class="metric-change positive"><i class="fas fa-check"></i> Padrão do sistema</div>
        </div>
      </div>
      <div class="metric-card">
        <div class="metric-icon pendentes"><i class="fas fa-lock"></i></div>
        <div class="metric-content">
          <h3>Contas Privadas</h3>
          <div class="metric-value">{{ contas_privadas|length if contas_privadas else 0 }}</div>
          <div class="metric-change warning"><i class="fas fa-building"></i> Por empresa</div>
        </div>
      </div>
    </div>
  </div>

  <div class="content-card">
    <div class="card-header">
      <h3><i class="fas fa-plus-circle"></i> Adicionar Nova Conta</h3>
      <div class="card-actions">
        <button type="button" class="btn btn-secondary" onclick="toggleForm('contaFormContainer')">
          <span id="toggle-icon-contaFormContainer">+</span> Expandir Formulário
        </button>
      </div>
    </div>
    <div id="contaFormContainer" class="hidden">
      <form action="{{ url_for('accounts.create_account') }}" method="post" class="form-grid" id="contaForm">
        <div class="form-group">
          <label for="idEmpresa">ID Empresa</label>
          <input type="text" id="idEmpresa" name="id_empresa" placeholder="ID da empresa (somente contas privadas)">
        </div>
        <div class="form-group">
          <label for="conta">Conta</label>
          <input type="text" id="conta" name="conta" placeholder="Ex: Salário, INSS, FGTS" required>
        </div>
        <div class="form-group">
          <label for="codigo">Código</label>
          <input style="height: 43px;" type="number" id="codigo" name="codigo" placeholder="Código da conta..." required>
        </div>
        <div class="form-group">
          <label for="tipo_empresa">Tipo Empresa</label>
          <select id="tipo_empresa" name="tipo">
            <option value="Matriz">Matriz</option>
            <option value="Filial">Filial</option>
          </select>
        </div>
        <div class="form-group">
          <label for="tipo_conta">Tipo Conta</label>
          <select id="tipo_conta" name="tipo_conta">
            <option value="publica">Pública</option>
            <option value="privada">Privada</option>
          </select>
        </div>
        <div class="form-actions">
          <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Adicionar Conta</button>
          <button type="reset" class="btn btn-secondary"><i class="fas fa-undo"></i> Limpar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Contas Públicas -->
  <div class="content-card">
    <div class="card-header">
      <h3><i class="fas fa-globe"></i> Contas Padrões (Públicas)</h3>
      <div class="card-actions">
        <span class="status-badge status-active">{{ contas|length if contas else 0 }} contas</span>
      </div>
    </div>
    <div class="table-container">
      {% if contas %}
      <table class="data-table">
        <thead>
          <tr>
            <th><i class="fas fa-hashtag"></i> Código</th>
            <th><i class="fas fa-file-invoice"></i> Nome da Conta</th>
            <th><i class="fas fa-building"></i> Tipo Empresa</th>
            <th><i class="fas fa-tag"></i> Categoria</th>
            <th><i class="fas fa-cog"></i> Ações</th>
          </tr>
        </thead>
        <tbody>
          {% for conta in contas %}
          <tr>
            <td>#{{ conta.conta_codigo }}</td>
            <td><strong>{{ conta.conta_nome }}</strong></td>
            <td>
              <span class="status-badge {% if conta.conta_tipo == 'Matriz' %}status-active{% else %}status-pending{% endif %}">
                {{ conta.conta_tipo }}
              </span>
            </td>
            <td><span class="metric-change neutral"><i class="fas fa-globe"></i> Pública</span></td>
            <td>
              <div class="card-actions">
                <button type="button" class="btn btn-outline" data-toggle-edit="editForm-publica-{{ conta.conta_codigo }}">
                  <i class="fas fa-edit"></i>
                </button>
                <form action="{{ url_for('accounts.delete_account') }}" method="post" style="display:inline;" onsubmit="return confirm('Tem certeza que deseja excluir esta conta?');">
                  <input type="hidden" name="id" value="{{ conta.conta_codigo }}">
                  <button type="submit" class="btn btn-danger"><i class="fas fa-trash"></i></button>
                </form>
              </div>
            </td>
          </tr>
          <!-- Formulário de Edição -->
          <tr id="editForm-publica-{{ conta.conta_codigo }}" class="edit-form-row hidden">
            <td colspan="5" class="edit-form-container">
              <div class="card-header">
                <h4><i class="fas fa-edit"></i> Editando: {{ conta.conta_nome }}</h4>
              </div>
              <form action="{{ url_for('accounts.edit_account') }}" method="post" class="form-grid">
                <input type="hidden" name="tipo_conta" value="publica">
                
                <div class="form-group">
                  <label for="edit_codigo_{{ conta.conta_codigo }}">Código</label>
                  <input type="number" id="edit_codigo_{{ conta.conta_codigo }}" name="conta_codigo" value="{{ conta.conta_codigo }}" required>
                </div>
                
                <div class="form-group">
                  <label for="edit_conta_{{ conta.conta_codigo }}">Nome da Conta</label>
                  <input type="text" id="edit_conta_{{ conta.conta_codigo }}" name="conta" value="{{ conta.conta_nome }}" required>
                </div>
                
                <div class="form-group">
                  <label for="edit_tipo_{{ conta.conta_codigo }}">Tipo Empresa</label>
                  <select id="edit_tipo_{{ conta.conta_codigo }}" name="tipo">
                    <option value="Matriz" {% if conta.conta_tipo == 'Matriz' %}selected{% endif %}>Matriz</option>
                    <option value="Filial" {% if conta.conta_tipo == 'Filial' %}selected{% endif %}>Filial</option>
                  </select>
                </div>
                <input type="hidden" name="id" value="{{ conta.conta_codigo }}">
                <div class="form-actions">
                  <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Salvar Alterações
                  </button>
                  <button type="button" class="btn btn-secondary" data-cancel-edit="editForm-publica-{{ conta.conta_codigo }}">
                    <i class="fas fa-times"></i> Cancelar
                  </button>
                </div>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p class="info-text"><i class="fas fa-info-circle"></i> Nenhuma conta pública registrada ainda.</p>
      {% endif %}
    </div>
  </div>

  <!-- Contas Privadas -->
  <div class="content-card">
    <div class="card-header">
      <h3><i class="fas fa-lock"></i> Contas Privadas</h3>
      <div class="card-actions">
        <span class="status-badge status-pending">{{ contas_privadas|length if contas_privadas else 0 }} contas</span>
      </div>
    </div>
    <div class="table-container">
      {% if contas_privadas %}
      <table class="data-table">
        <thead>
          <tr>
            <th><i class="fas fa-building"></i> ID Empresa</th>
            <th><i class="fas fa-hashtag"></i> Código</th>
            <th><i class="fas fa-file-invoice"></i> Nome da Conta</th>
            <th><i class="fas fa-building"></i> Tipo Empresa</th>
            <th><i class="fas fa-tag"></i> Categoria</th>
            <th><i class="fas fa-cog"></i> Ações</th>
          </tr>
        </thead>
        <tbody>
          {% for conta in contas_privadas %}
          <tr>
            <td>{{ conta.empresa_id }}</td>
            <td>#{{ conta.conta_codigo }}</td>
            <td><strong>{{ conta.conta_nome }}</strong></td>
            <td>
              <span class="status-badge {% if conta.conta_tipo == 'Matriz' %}status-active{% else %}status-pending{% endif %}">
                {{ conta.conta_tipo }}
              </span>
            </td>
            <td><span class="metric-change warning"><i class="fas fa-lock"></i> Privada</span></td>
            <td>
              <div class="card-actions">
                <button type="button" class="btn btn-outline" data-toggle-edit="editForm-privada-{{ conta.empresa_id }}-{{ conta.conta_codigo }}">
                  <i class="fas fa-edit"></i>
                </button>
                <form action="{{ url_for('accounts.delete_account') }}" method="post" style="display:inline;" onsubmit="return confirm('Tem certeza que deseja excluir esta conta privada?');">
                  <input type="hidden" name="empresa_id" value="{{ conta.empresa_id }}">
                  <input type="hidden" name="id" value="{{ conta.conta_codigo }}">
                  <button type="submit" class="btn btn-danger"><i class="fas fa-trash"></i></button>
                </form>
              </div>
            </td>
          </tr>
          <!-- Formulário de Edição -->
          <tr id="editForm-privada-{{ conta.empresa_id }}-{{ conta.conta_codigo }}" class="edit-form-row hidden">
            <td colspan="6" class="edit-form-container">
              <div class="card-header">
                <h4><i class="fas fa-edit"></i> Editando: {{ conta.conta_nome }} (ID Empresa: {{ conta.empresa_id }})</h4>
              </div>
              <form action="{{ url_for('accounts.edit_account') }}" method="post" class="form-grid">
                <input type="hidden" name="original_codigo" value="{{ conta.conta_codigo }}">
                <input type="hidden" name="original_empresa_id" value="{{ conta.empresa_id }}">
                <input type="hidden" name="tipo_conta" value="privada">
                
                <div class="form-group">
                  <label for="edit_empresa_id_{{ conta.empresa_id }}_{{ conta.conta_codigo }}">ID Empresa</label>
                  <input type="text" id="edit_empresa_id_{{ conta.empresa_id }}_{{ conta.conta_codigo }}" name="empresa_id" value="{{ conta.empresa_id }}" required>
                </div>
                
                <div class="form-group">
                  <label for="edit_codigo_{{ conta.empresa_id }}_{{ conta.conta_codigo }}">Código</label>
                  <input type="number" id="edit_codigo_{{ conta.empresa_id }}_{{ conta.conta_codigo }}" name="codigo" value="{{ conta.conta_codigo }}" required>
                </div>
                
                <div class="form-group">
                  <label for="edit_conta_{{ conta.empresa_id }}_{{ conta.conta_codigo }}">Nome da Conta</label>
                  <input type="text" id="edit_conta_{{ conta.empresa_id }}_{{ conta.conta_codigo }}" name="conta" value="{{ conta.conta_nome }}" required>
                </div>
                
                <div class="form-group">
                  <label for="edit_tipo_{{ conta.empresa_id }}_{{ conta.conta_codigo }}">Tipo Empresa</label>
                  <select id="edit_tipo_{{ conta.empresa_id }}_{{ conta.conta_codigo }}" name="tipo">
                    <option value="Matriz" {% if conta.conta_tipo == 'Matriz' %}selected{% endif %}>Matriz</option>
                    <option value="Filial" {% if conta.conta_tipo == 'Filial' %}selected{% endif %}>Filial</option>
                  </select>
                </div>
                
                <div class="form-actions">
                  <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Salvar Alterações
                  </button>
                  <button type="button" class="btn btn-secondary" data-cancel-edit="editForm-privada-{{ conta.empresa_id }}-{{ conta.conta_codigo }}">
                    <i class="fas fa-times"></i> Cancelar
                  </button>
                </div>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p class="info-text"><i class="fas fa-info-circle"></i> Nenhuma conta privada registrada ainda.</p>
      {% endif %}
    </div>
  </div>

</section>
{% endblock %}